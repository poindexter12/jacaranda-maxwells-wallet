---
# Maxwell's Wallet Deployment Playbook
#
# Usage:
#   ansible-playbook playbooks/deploy.yaml -i inventory/prod.yaml \
#     -e "cloudflare_tunnel_token_demo=$DEMO_TOKEN" \
#     -e "cloudflare_tunnel_token_beta=$BETA_TOKEN" \
#     -e "cloudflare_api_token=$CF_API_TOKEN"

- name: Deploy Maxwell's Wallet
  hosts: maxwells_wallet
  become: true

  vars:
    # Set tunnel token based on wallet_env (renamed from 'environment' which is Ansible reserved)
    cloudflare_tunnel_token: "{{ cloudflare_tunnel_token_demo if wallet_env == 'demo' else cloudflare_tunnel_token_beta }}"

  pre_tasks:
    - name: Validate tunnel token is provided
      ansible.builtin.assert:
        that:
          - cloudflare_tunnel_token is defined
          - cloudflare_tunnel_token | length > 0
        fail_msg: "Cloudflare tunnel token not provided for {{ wallet_env }}"
        quiet: true

    - name: Validate Cloudflare API token is provided
      ansible.builtin.assert:
        that:
          - cloudflare_api_token is defined
          - cloudflare_api_token | length > 0
        fail_msg: "Cloudflare API token not provided (needed for DNS validation)"
        quiet: true

    - name: Wait for VM to be ready
      ansible.builtin.wait_for_connection:
        timeout: 120

  roles:
    - maxwells-wallet

  post_tasks:
    - name: Verify containers are running
      community.docker.docker_container_info:
        name: "{{ item }}"
      register: container_info
      loop:
        - swag
        - maxwells-wallet
        - watchtower
      failed_when: container_info.container is none or not container_info.container.State.Running

    - name: Display access information
      ansible.builtin.debug:
        msg: |
          âœ“ Maxwell's Wallet deployed!

          Domain: https://{{ domain }}
          Image tag: {{ image_tag }}

          SWAG is handling SSL certificates via Cloudflare DNS validation.
          Cloudflare Tunnel routes traffic through the tunnel.
          Watchtower will auto-update when new :{{ image_tag }} images are pushed.
