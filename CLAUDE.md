# Maxwell's Wallet Service

**Repository:** jacaranda-maxwells-wallet (extracted from monorepo)
**Purpose:** Host demo and beta versions of Maxwell's Wallet via Cloudflare Tunnels
**Secrets:** 1Password `op://Homelab/maxwells-wallet-{demo,beta}/password`

## Agent Boundaries

**THIS REPOSITORY IS STANDALONE.** Do not reference other services.

**Positive constraints (what agents SHOULD do):**
- Reference lib/ submodule for shared infrastructure modules
- Use base-infra module for infrastructure outputs
- Follow VM-based service patterns
- Maintain Ansible .yml extension files (roles tasks/defaults/handlers)
- Use 1Password via op-read and op-connect.sh scripts
- Deploy via just prod::full or just prod::deploy
- Update providers via just upgrade

**Negative constraints (what agents MUST NOT do):**
- Do not reference sibling service repos (jacaranda-redis, jacaranda-pihole, etc.)
- Do not reference hub monorepo patterns (this is standalone)
- Do not change Ansible .yml extensions to .yaml (roles use .yml convention)
- Do not add test environment (MW only has prod with demo + beta instances)
- Do not create custom terraform modules (use shared VM module from lib/)
- Do not bypass 1Password scripts (no direct op read calls)

**File map:**
- `justfile` - Root recipes with mod prod
- `prod.just` - Production environment recipes
- `terraform/envs/prod/main.tf` - Terraform using base-infra + shared VM module
- `ansible/` - Ansible playbooks and roles (maxwells-wallet role)
- `lib/` - Shared-libs submodule (v1.4.0)
- `mise.toml` - Tool versions (just, opentofu, uv, pre-commit)
- `pyproject.toml` - Python 3.12 + Ansible 2.17 dependencies

## Quick Reference

**Quick Commands:**

```bash
cd jacaranda-maxwells-wallet
just --list              # Show all commands
just check-secrets       # Verify 1Password items exist
just prod::full          # Create VMs + deploy
just prod::validate      # Check deployment health
just prod::destroy       # Destroy VMs
just upgrade             # Upgrade OpenTofu providers
```

## Architecture

**Two VMs hosting different versions:**

| Hostname | VMID | Node | Transfer IP | Mgmt IP | Domain | Image Tag |
| ---------- | ------ | ------ | ------------- | --------- | -------- | ----------- |
| maxwells-wallet-demo | 1070 | joseph | 192.168.11.70 | 192.168.5.70 | demo.maxwellswallet.com | `:latest` |
| maxwells-wallet-beta | 1071 | maxwell | 192.168.11.71 | 192.168.5.71 | beta.maxwellswallet.com | `:beta` |

**VM Resources:**

| Resource | Value |
| ---------- | ------- |
| Template | tmpl-ubuntu-2404-docker (1020) |
| CPU | 1 core |
| Memory | 1024 MB |
| Root Disk | 20G (ceph-seymour) |
| Clone Type | Linked clone (thin) |
| Network | VLAN 11 (transfer) + VLAN 5 (mgmt) |

**Why VMs instead of LXC?**
Docker-in-Docker (DinD) requires full kernel access for cgroups and procfs operations that don't work reliably in LXC containers, even with nesting and privileged mode enabled.

**Components per VM:**

| Container | Purpose |
| ----------- | --------- |
| swag | SWAG reverse proxy + Cloudflare Tunnel (via universal-cloudflared mod) |
| maxwells-wallet | Next.js app with embedded backend |
| watchtower | Auto-updates containers on new images |

## Traffic Flow

```text
Internet
    ↓
Cloudflare Edge (rate limiting, WAF)
    ↓
Cloudflare Tunnel (encrypted, via SWAG universal-cloudflared mod)
    ↓
SWAG (nginx reverse proxy)
    ↓
maxwells-wallet container (Next.js)
    ↓
SQLite (demo data)
```

**Key Points:**

- No inbound ports exposed on VMs
- All traffic goes through Cloudflare Tunnel (outbound from VM)
- Rate limiting configured in Cloudflare Dashboard
- Watchtower polls GHCR every 5 minutes for new images
- VMs use linked clones on Ceph storage for fast provisioning

## Directory Structure

```text
jacaranda-maxwells-wallet/
├── CLAUDE.md                     # This file
├── justfile                      # Module-based recipe organization
├── prod.just                     # Production environment recipes
├── mise.toml                     # Tool versions
├── pyproject.toml                # Python dependencies
├── .envrc                        # direnv integration
├── .envrc.secrets.example        # Secrets template
├── scripts/
│   ├── op-read                   # 1Password read wrapper
│   └── op-connect.sh             # 1Password Connect injection
├── lib/                          # Shared-libs submodule (v1.4.0)
└── terraform/
    └── envs/
        └── prod/
            ├── main.tf           # Production instances
            ├── encryption.tf     # State encryption
            └── justfile
└── ansible/
    ├── ansible.cfg
    ├── inventory/
    │   └── prod.yaml             # Auto-generated by Terraform
    ├── host_vars/
    │   ├── maxwells-wallet-demo.yml
    │   └── maxwells-wallet-beta.yml
    ├── playbooks/
    │   └── deploy.yaml
    └── roles/maxwells-wallet/
        ├── defaults/main.yml
        ├── tasks/main.yml
        ├── templates/
        │   ├── docker-compose.yml.j2
        │   └── nginx.conf.j2
        └── handlers/main.yml
```

## Secrets

**1Password Items Required:**

| Item | Field | Purpose |
| ------ | ------- | --------- |
| `maxwells-wallet-demo` | `password` | Cloudflare tunnel token for demo |
| `maxwells-wallet-beta` | `password` | Cloudflare tunnel token for beta |
| `cloudflare-maxwells-wallet` | `api-token` | DNS validation for Let's Encrypt |
| `github` | `pat` | GHCR authentication for pulling images |

**Creating Tunnel Tokens:**

1. Go to Cloudflare Dashboard → Zero Trust → Networks → Tunnels
2. Create tunnel: `mw-demo` (or `mw-beta`)
3. Configure public hostname: `demo.maxwellswallet.com` → `http://localhost:80`
4. Copy the tunnel token (JWT format starting with `eyJ...`)
5. Save to 1Password:

   ```bash
   op item create --vault Homelab --category "Secure Note" \
     --title "maxwells-wallet-demo" \
     password="<tunnel-token>"
   ```

## Deployment Workflow

### Initial Setup

```bash
cd jacaranda-maxwells-wallet

# 1. Create Cloudflare tunnels and save tokens to 1Password
# (see "Creating Tunnel Tokens" above)

# 2. Verify secrets exist
just check-secrets

# 3. Initialize OpenTofu
just prod::init

# 4. Create VMs + deploy
just prod::full

# 5. Verify deployment
just prod::validate
```

### Update Deployments

Watchtower handles automatic updates when new images are pushed to GHCR.

**Manual redeploy:**

```bash
just prod::deploy      # Both
just deploy-demo      # Demo only
just deploy-beta      # Beta only
```

## Auto-Update Behavior

| Instance | Image Tag | Updates When |
| ---------- | ----------- | -------------- |
| maxwells-wallet-demo | `:latest` | New release published (v*.*.*) |
| maxwells-wallet-beta | `:beta` | New beta tag pushed |

Watchtower checks every 5 minutes. No manual intervention needed.

## Rate Limiting (Cloudflare)

Configure in Cloudflare Dashboard → Security → WAF → Rate limiting rules:

**Recommended rules:**

- 100 requests/minute per IP (general)
- 10 requests/minute per IP for `/api/*` endpoints
- Block after 5 failed login attempts

## Common Operations

### Check Container Status

```bash
just prod::validate

# Or SSH directly (note: user is ubuntu, not root)
ssh ubuntu@192.168.5.70 "docker ps"
ssh ubuntu@192.168.5.71 "docker ps"
```

### View Logs

```bash
just prod::logs

# Or specific container
ssh ubuntu@192.168.5.70 "docker logs maxwells-wallet --tail 50"
ssh ubuntu@192.168.5.70 "docker logs swag --tail 50"
```

### Force Update

```bash
# Trigger watchtower to check now
ssh ubuntu@192.168.5.70 "docker exec watchtower /watchtower --run-once"
```

### Restart Containers

```bash
ssh ubuntu@192.168.5.70 "cd /opt/maxwells-wallet && docker compose restart"
```

## Troubleshooting

### Tunnel Not Connecting

```bash
# Check if cloudflared is running
ssh ubuntu@192.168.5.70 "docker exec swag pgrep -la cloudflared"

# Check SWAG logs for cloudflared mod output
ssh ubuntu@192.168.5.70 "docker logs swag 2>&1 | grep -i cloudflare"

# Common issues:
# - Invalid tunnel token (CF_REMOTE_MANAGE_TOKEN)
# - Network connectivity (check DNS)
# - Cloudflare tunnel deleted/reconfigured in dashboard
```

### Docker Not Working

```bash
# Check Docker service (pre-installed in template)
ssh ubuntu@192.168.5.70 "systemctl status docker"

# Restart Docker
ssh ubuntu@192.168.5.70 "sudo systemctl restart docker"
```

### App Not Loading

```bash
# Check all containers are running
ssh ubuntu@192.168.5.70 "docker ps"

# Check app logs
ssh ubuntu@192.168.5.70 "docker logs maxwells-wallet"

# Check SWAG logs
ssh ubuntu@192.168.5.70 "docker logs swag"
```

### Watchtower Not Updating

```bash
# Check watchtower logs
ssh ubuntu@192.168.5.70 "docker logs watchtower"

# Verify GHCR authentication
ssh ubuntu@192.168.5.70 "cat ~/.docker/config.json"
```

### Let's Encrypt Certificate Issues

```bash
# Check cert status
ssh ubuntu@192.168.5.70 "docker logs swag 2>&1 | grep -i cert"

# Common issues:
# - Cloudflare API token doesn't have DNS edit permission
# - DNS propagation delay (increase wait time)
# - Rate limiting from Let's Encrypt (staging mode helps)
```

## DO vs DON'T

### DO

- Configure rate limiting in Cloudflare Dashboard
- Use `just check-secrets` before first deployment
- Let Watchtower handle updates automatically
- SSH via mgmt network (192.168.5.x) or transfer network (192.168.11.x)
- Use Cloudflare Tunnel public hostname pointing to `http://localhost:80` (SWAG nginx)

### DON'T

- Expose ports directly (use Cloudflare Tunnel)
- Store tunnel tokens in git
- Modify VMs in Proxmox UI (Terraform-managed)
- Manually update containers (let Watchtower do it)
- Point Cloudflare Tunnel to port 3000 (use SWAG's port 80)
- Reference other service repositories (this is standalone)

## Development Setup

1. **Clone repository:**
   ```bash
   git clone git@github.com:poindexter12/jacaranda-maxwells-wallet.git
   cd jacaranda-maxwells-wallet
   ```

2. **Initialize submodule:**
   ```bash
   git submodule update --init --recursive
   ```

3. **Install tools via mise:**
   ```bash
   mise install
   ```

4. **Install Python dependencies:**
   ```bash
   uv sync
   ```

5. **Verify secrets access:**
   ```bash
   just check-secrets
   ```

6. **Ready to deploy:**
   ```bash
   just prod::full
   ```
